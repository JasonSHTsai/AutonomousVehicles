%% Setting
warning off ;close all ;clear all ;clc;
% close_system;
Fcncal_transctrl_Ts = 0.01 ;
Tf = 0.1 ;
Ts = 1;
%% Input Generation
%在低速的時候不要設計轉彎過大的情況,直線減速時速度絕對不能減至0.0002373以下,轉彎減速時速度不能減至0.2363以下，油門在0.02843以下就會有減速的情況
%{
load('ID_inf_example','t_sim','Steer','Accelcmd');
tsim = t_sim';
Tend = (length(tsim)-1)*Tf;
Steer_AS = Steer(1:42,:);
Accel_AS = Accelcmd(1:42,:);
Steer_bra = zeros(17,1);
Accel_bra = [Accel_AS(42), 0.5, 0.4, 0.3, 0.2, 0.1, 0, zeros(1,10)]'; %, -0.1, -0.2, -0.3, -0.4, -0.5
Steer_vd = zeros(41,1);
Accel_vd = [zeros(10,1); (-0.15).*ones(31,1)]; % 定值(-1).*ones(41,1)  線性(-0:-2.5e-3:-0.1)'

Steer_MBS = [Steer_bra;Steer_vd];
Accel_MBS = [Accel_bra;Accel_vd];
Steer_in = [tsim(1:100) [Steer_AS;Steer_MBS]]; %   Steer_AS
Accelcmd_in = [tsim(1:100) [Accel_AS;Accel_MBS]]; %  Accel_AS
%}
%{
% % 低速加速(LA)
% %   右轉:LAR 1
LAR = [[0,0.151,0.25,0.35,0.5];[0,0.06,0.12,0.18,0.24]];
% %   左轉:LAL 2
LAL = [[0,0.151,0.25,0.35,0.5];[0,-0.06,-0.12,-0.18,-0.24]];
% %   直線:LAS 3
LAS = [[0,0.0075,0.015,0.0225,0.03,0.0375,0.045,0.0525,0.06,0.0675,0.075,0.0825,0.09,0.0975,0.105,0.1125,0.12,0.1275];[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
% % 低速減速(LB)
% %   右轉:LBR 4
LBR = [[0.02*ones(12,1)' 0.0*ones(24,1)' -0.10*ones(24,1)' ];[0.24*ones(24,1)' 0.12*ones(24,1)' 0.06*ones(12,1)']];
% %   左轉:LBL 5 
LBL = [[0.02*ones(12,1)' 0.0*ones(24,1)' -0.10*ones(24,1)' ];[-0.24*ones(24,1)' -0.12*ones(24,1)' -0.06*ones(12,1)']];
% %   直線:LBS 6
LBS = [[0.02*ones(12,1)' 0.0*ones(24,1)' -0.10*ones(18,1)' ];zeros(54,1)' ];
% % 中速加速(MA)
% %   右轉:MAR 7
MAR = [[0,0.00500000000000000,0.0100000000000000,0.0150000000000000,0.0200000000000000,0.0250000000000000,0.0300000000000000,0.0350000000000000,0.0400000000000000,0.0450000000000000,0.0500000000000000,0.0550000000000000,0.0600000000000000,0.0650000000000000,0.0700000000000000,0.0750000000000000,0.0800000000000000,0.0850000000000000,0.0900000000000000,0.0950000000000000,0.100000000000000,0.105000000000000,0.110000000000000,0.115000000000000,0.120000000000000,0.125000000000000,0.130000000000000,0.135000000000000,0.140000000000000,0.145000000000000,0.150000000000000,0.155000000000000,0.160000000000000,0.165000000000000,0.170000000000000,0.175000000000000,0.180000000000000,0.185000000000000];[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.0985157556878072,0.195952152140552,0.291241655808820,0.383340254949812,0.471238898038469,0.553974549147137,0.630640739168722,0.700397497281915,0.762480553847289,0.816209713905398,0.860996309535096,0.896349649422467,0.921882394977542,0.937314804096949,0.942477796076938,0.937314804096949]];
% %   左轉:MAL 8
MAL = [[0,0.00500000000000000,0.0100000000000000,0.0150000000000000,0.0200000000000000,0.0250000000000000,0.0300000000000000,0.0350000000000000,0.0400000000000000,0.0450000000000000,0.0500000000000000,0.0550000000000000,0.0600000000000000,0.0650000000000000,0.0700000000000000,0.0750000000000000,0.0800000000000000,0.0850000000000000,0.0900000000000000,0.0950000000000000,0.100000000000000,0.105000000000000,0.110000000000000,0.115000000000000,0.120000000000000,0.125000000000000,0.130000000000000,0.135000000000000,0.140000000000000,0.145000000000000,0.150000000000000,0.155000000000000,0.160000000000000,0.165000000000000,0.170000000000000,0.175000000000000,0.180000000000000,0.185000000000000];[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.0985157556878072,-0.195952152140552,-0.291241655808820,-0.383340254949812,-0.471238898038469,-0.553974549147137,-0.630640739168722,-0.700397497281915,-0.762480553847289,-0.816209713905398,-0.860996309535096,-0.896349649422467,-0.921882394977542,-0.937314804096949,-0.942477796076938,-0.937314804096949]];
% %   直線:MAS 9
MAS = [[0,0.00500000000000000,0.0100000000000000,0.0150000000000000,0.0200000000000000,0.0250000000000000,0.0300000000000000,0.0350000000000000,0.0400000000000000,0.0450000000000000,0.0500000000000000,0.0550000000000000,0.0600000000000000,0.0650000000000000,0.0700000000000000,0.0750000000000000,0.0800000000000000,0.0850000000000000,0.0900000000000000,0.0950000000000000,0.100000000000000,0.105000000000000,0.110000000000000,0.115000000000000,0.120000000000000,0.125000000000000,0.130000000000000,0.135000000000000,0.140000000000000,0.145000000000000,0.150000000000000,0.155000000000000,0.160000000000000,0.165000000000000,0.170000000000000,0.175000000000000,0.180000000000000,0.185000000000000];[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
% % 中速減速(MB)
% %   右轉:MBR 10 
MBR = [[0.01*ones(12,1)' 0.0*ones(12,1)' -0.10*ones(9,1)' ];[0.8*ones(12,1)' 0.5*ones(12,1)' 0.22*ones(9,1)']];
% %   左轉:MBL 11
MBL = [[0.01*ones(12,1)' 0.0*ones(12,1)' -0.10*ones(9,1)' ];[-0.8*ones(12,1)' -0.5*ones(12,1)' -0.22*ones(9,1)']];
% %   直線:MBS 12
MBS = [[0.02*ones(12,1)' 0.0*ones(12,1)' -0.10*ones(12,1)' ];zeros(36,1)' ];
% % 高速加速(HA)
% %   右轉:HAR 13
HAR = [[0,0.0150000000000000,0.0300000000000000,0.0450000000000000,0.0600000000000000,0.0750000000000000,0.0900000000000000,0.105000000000000,0.120000000000000,0.135000000000000,0.150000000000000,0.165000000000000,0.180000000000000,0.195000000000000,0.210000000000000,0.225000000000000,0.240000000000000,0.255000000000000,0.270000000000000,0.285000000000000,0.300000000000000,0.315000000000000,0.330000000000000,0.345000000000000,0.360000000000000,0.375000000000000,0.390000000000000,0.405000000000000,0.420000000000000,0.435000000000000,0.450000000000000,0.465000000000000,0.480000000000000,0.495000000000000,0.510000000000000,0.525000000000000,0.540000000000000,0.555000000000000,0.570000000000000,0.585000000000000,0.600000000000000,0.615000000000000,0.630000000000000,0.645000000000000,0.660000000000000,0.675000000000000];[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.197031511375614,0.391904304281103,0.582483311617640,0.766680509899625,0.942477796076938,1.10794909829427,1.26128147833744,1.40079499456383,1.52496110769458,1.63241942781080,1.72199261907019,1.79269929884493,1.84376478995508,1.87462960819390,1.88495559215388,1.87462960819390,1.84376478995508,1.79269929884493,1.72199261907019,1.63241942781080,1.52496110769458,1.40079499456383,1.26128147833744,1.10794909829427,0.942477796076938,0.766680509899625]];
% %   左轉:HAL 14
HAL = [[0,0.0150000000000000,0.0300000000000000,0.0450000000000000,0.0600000000000000,0.0750000000000000,0.0900000000000000,0.105000000000000,0.120000000000000,0.135000000000000,0.150000000000000,0.165000000000000,0.180000000000000,0.195000000000000,0.210000000000000,0.225000000000000,0.240000000000000,0.255000000000000,0.270000000000000,0.285000000000000,0.300000000000000,0.315000000000000,0.330000000000000,0.345000000000000,0.360000000000000,0.375000000000000,0.390000000000000,0.405000000000000,0.420000000000000,0.435000000000000,0.450000000000000,0.465000000000000,0.480000000000000,0.495000000000000,0.510000000000000,0.525000000000000,0.540000000000000,0.555000000000000,0.570000000000000,0.585000000000000,0.600000000000000,0.615000000000000,0.630000000000000,0.645000000000000,0.660000000000000,0.675000000000000];[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.197031511375614,-0.391904304281103,-0.582483311617640,-0.766680509899625,-0.942477796076938,-1.10794909829427,-1.26128147833744,-1.40079499456383,-1.52496110769458,-1.63241942781080,-1.72199261907019,-1.79269929884493,-1.84376478995508,-1.87462960819390,-1.88495559215388,-1.87462960819390,-1.84376478995508,-1.79269929884493,-1.72199261907019,-1.63241942781080,-1.52496110769458,-1.40079499456383,-1.26128147833744,-1.10794909829427,-0.942477796076938,-0.766680509899625]];
% %   直線:HAS 15
HAS = [[0,0.0150000000000000,0.0300000000000000,0.0450000000000000,0.0600000000000000,0.0750000000000000,0.0900000000000000,0.105000000000000,0.120000000000000,0.135000000000000,0.150000000000000,0.165000000000000,0.180000000000000,0.195000000000000,0.210000000000000,0.225000000000000,0.240000000000000,0.255000000000000,0.270000000000000,0.285000000000000,0.300000000000000,0.315000000000000,0.330000000000000,0.345000000000000,0.360000000000000,0.375000000000000,0.390000000000000,0.405000000000000,0.420000000000000,0.435000000000000,0.450000000000000,0.465000000000000,0.480000000000000,0.495000000000000,0.510000000000000,0.525000000000000,0.540000000000000,0.555000000000000,0.570000000000000,0.585000000000000,0.600000000000000,0.615000000000000,0.630000000000000,0.645000000000000,0.660000000000000,0.675000000000000];[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
% % 高速減速(HB)
% %   右轉:HBR 16
HBR = [[ 0.02*ones(12,1)' 0.01*ones(12,1)' 0.0*ones(12,1)' -0.10*ones(10,1)' ];[0.8*ones(12,1)' 0.5*ones(12,1)' 0.3*ones(12,1)' 0.22*ones(10,1)']];
% %   左轉:HBL 17
HBL = [[ 0.02*ones(12,1)' 0.01*ones(12,1)' 0.0*ones(12,1)' -0.10*ones(10,1)' ];[-0.8*ones(12,1)' -0.5*ones(12,1)' -0.4*ones(12,1)' -0.22*ones(10,1)']];
% %   直線:HBS 18
HBS = [[0.02*ones(12,1)' 0.01*ones(12,1)' 0.0*ones(12,1)' -0.10*ones(17,1)' ];zeros(53,1)' ];
% x = 0:0.1:4.5;
% y = 0.15.*x;
% ref = 0.*x;
% q = 0:0.1:2.6;
% w = 0.3*2*pi*sin(q*pi/3)
% ref = [zeros(19,1)' -w  ]

Accelcmd_tmp = [LAR(1,:)';LBR(1,:)'];
Steer_tmp = [   LAR(2,:)';LBR(2,:)'];         
plot(Steer_tmp(1,:))
Tend = (length(Accelcmd_tmp)-1)*Ts;tsim = (0:Tf:Tend)';tsam = (0:Ts:Tend)';Accelcmd = interp1(tsam, Accelcmd_tmp, tsim, 'cubic');Accelcmd = [ tsim Accelcmd ] ;Steer = interp1(tsam, Steer_tmp, tsim, 'cubic');Steer = [ tsim Steer ] ;
%}
%% Mirror
% load('ID_inf_example','t_sim','Steer','Accelcmd');
% tsim = t_sim';
% Tend = (length(tsim)-1)*Tf;
% Steer = (-1).*Steer;
% Steer_in = [tsim Steer];
% Accelcmd_in = [tsim Accelcmd];
%% Input of Part 2 Fig. 14
tsim = 0:Tf:93;
tsim = tsim';
num = 93/Tf+1;
Steer = zeros(num,1);
Steer_in = [tsim Steer];
Accelcmd = [0.01*ones(15,1); 0.02*ones(65,1); 0.06*ones(250,1); 0.02*ones(15,1); zeros(65,1); -0.1*ones(521,1);];
Accelcmd_in = [tsim Accelcmd];
%% Sim
sim('open_loop',0:Tf:93);
% load('routeforMBS');
% [~,~,~,select_MPC] = select_model_1227_v2(Velocity,Heading,5.628,10.82,25,8,2);
% figure();plot(select_MPC);

%{
temp = select_Model(end,1);
len = -1;
for i = length(select_Model):-1:1
    if(select_Model(i,1) ~= temp)
        break;
    end
    len = len + 1;
end
%}

%% Plot bug in the braking part (Part 2 Fig. 14)
figure();
plot(tsim,Accelcmd_in(:,2));
title('Accelcmd');
figure();
plot(tsim,Steer_in(:,2));
title('Steer');
figure();
plot(tsim,Velocity);
title('Velocity');
figure()
plot(tsim,Heading);
title('Heading');

% Steer = Steer_in(:,2);
% Accelcmd = Accelcmd_in(:,2);
% tsim = Steer_in(:,1);
% save('routeforMBS', 'Accelcmd', 'Steer', 'Velocity', 'Heading', 'tsim', 'XYplot') ;
%}

